<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Ng∆∞·ªùi D√πng - Admin</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="admin-style.css">
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center
        }

        .modal.show {
            display: flex
        }

        .modal-content {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            max-width: 400px;
            width: 90%
        }

        .form-group {
            margin-bottom: 1rem
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold
        }

        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <aside class="admin-sidebar">
            <h2>Admin Panel</h2>
            <ul class="admin-menu">
                <li><a href="/admin/dashboard.html">Dashboard</a></li>
                <li><a href="/admin/books.html">Qu·∫£n L√Ω S√°ch</a></li>
                <li><a href="/admin/orders.html">Qu·∫£n L√Ω ƒê∆°n H√†ng</a></li>
                <li><a href="/admin/gift-orders.html">Qu·∫£n L√Ω ƒê∆°n Qu√† T·∫∑ng</a></li>
                <li><a href="/admin/gift-packages.html">Qu·∫£n L√Ω G√≥i Qu√†</a></li>
                <li><a href="/admin/users.html" class="active">Qu·∫£n L√Ω Ng∆∞·ªùi D√πng</a></li>
                <li><a href="/admin/memberships.html">Qu·∫£n L√Ω Th·∫ª Th√†nh Vi√™n</a></li>
                <li><a href="/index.html">V·ªÅ Trang Ch·ªß</a></li>
            </ul>
        </aside>
        <main class="admin-content">
            <h1 style="color:#2d6a4f;margin-bottom:1.5rem">Qu·∫£n L√Ω Ng∆∞·ªùi D√πng</h1>
            <div style="margin-bottom:1rem">
                <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm theo t√™n, email, s·ªë ƒëi·ªán tho·∫°i..."
                    style="width:100%;max-width:500px;padding:0.75rem;border:1px solid #ddd;border-radius:4px;font-size:14px"
                    oninput="filterUsers()">
            </div>
            <div class="admin-section">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>T√™n ƒêƒÉng Nh·∫≠p</th>
                            <th>H·ªç T√™n</th>
                            <th>Email</th>
                            <th>S·ªë ƒêi·ªán Tho·∫°i</th>
                            <th>Vai Tr√≤</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <tr>
                            <td colspan="7" style="text-align:center">ƒêang t·∫£i...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="roleModal" class="modal">
        <div class="modal-content">
            <h2>S·ª≠a Vai Tr√≤</h2>
            <div class="form-group">
                <label>Vai Tr√≤</label>
                <select id="roleSelect">
                    <option value="USER">USER</option>
                    <option value="ADMIN">ADMIN</option>
                </select>
            </div>
            <div style="display:flex;gap:1rem;margin-top:1.5rem">
                <button class="btn btn-primary" onclick="saveRole()">L∆∞u</button>
                <button class="btn btn-outline" onclick="closeModal()">H·ªßy</button>
            </div>
        </div>
    </div>

    <script src="/js/notification.js"></script>
    <script>
        let allUsers = [], editingUserId = null;
        fetch('/admin/api/users', { credentials: 'include' })
            .then(r => r.json())
            .then(users => { allUsers = users; displayUsers(users); })
            .catch(() => document.getElementById('usersTable').innerHTML = '<tr><td colspan="7" style="text-align:center">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</td></tr>');
        function displayUsers(users) {
            document.getElementById('usersTable').innerHTML = users.length ? users.map(u => `
                <tr>
                    <td>${u.userId}</td>
                    <td>${u.userName}</td>
                    <td>${u.fullName || 'N/A'}</td>
                    <td>${u.email || 'N/A'}</td>
                    <td>${u.phone || 'N/A'}</td>
                    <td><span style="padding:4px 8px;background:${u.role === 'ADMIN' ? '#dc3545' : '#28a745'};color:#fff;border-radius:4px;font-size:12px">${u.role}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editRole(${u.userId},'${u.role}')">S·ª≠a Vai Tr√≤</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.userId})">X√≥a</button>
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="7" style="text-align:center">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng</td></tr>';
        }
        function filterUsers() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allUsers.filter(u =>
                (u.userName || '').toLowerCase().includes(q) ||
                (u.fullName || '').toLowerCase().includes(q) ||
                (u.email || '').toLowerCase().includes(q) ||
                (u.phoneNumber || '').includes(q) ||
                (u.userId + '').includes(q)
            );
            displayUsers(filtered);
        }
        function editRole(userId, currentRole) {
            editingUserId = userId;
            document.getElementById('roleSelect').value = currentRole;
            document.getElementById('roleModal').classList.add('show');
        }
        function closeModal() {
            document.getElementById('roleModal').classList.remove('show');
            editingUserId = null;
        }
        function saveRole() {
            const role = document.getElementById('roleSelect').value;
            fetch(`/admin/api/users/${editingUserId}/role`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role }),
                credentials: 'include'
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        showSuccess('Th√†nh C√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t vai tr√≤');
                        closeModal();
                        fetch('/admin/api/users', { credentials: 'include' })
                            .then(r => r.json())
                            .then(users => { allUsers = users; displayUsers(users); });
                    } else {
                        showError('L·ªói', data.error || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t vai tr√≤');
                    }
                })
                .catch(() => showError('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t vai tr√≤'));
        }
        function deleteUser(userId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?')) return;
            fetch(`/admin/api/users/${userId}`, { method: 'DELETE', credentials: 'include' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        showSuccess('Th√†nh C√¥ng', 'ƒê√£ x√≥a ng∆∞·ªùi d√πng');
                        fetch('/admin/api/users', { credentials: 'include' })
                            .then(r => r.json())
                            .then(users => { allUsers = users; displayUsers(users); });
                    } else {
                        showError('L·ªói', data.error || 'Kh√¥ng th·ªÉ x√≥a ng∆∞·ªùi d√πng');
                    }
                })
                .catch(() => showError('L·ªói', 'Kh√¥ng th·ªÉ x√≥a ng∆∞·ªùi d√πng'));
        }
    </script>
</body>

</html>