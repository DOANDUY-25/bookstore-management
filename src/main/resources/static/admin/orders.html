<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω ƒê∆°n H√†ng - Admin</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="admin-style.css">
    <style>
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold
        }

        .badge-pending {
            background: #ffc107;
            color: #000
        }

        .badge-confirmed {
            background: #17a2b8;
            color: #fff
        }

        .badge-shipped {
            background: #007bff;
            color: #fff
        }

        .badge-delivered {
            background: #28a745;
            color: #fff
        }

        .badge-cancelled {
            background: #dc3545;
            color: #fff
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <aside class="admin-sidebar">
            <h2>Admin Panel</h2>
            <ul class="admin-menu">
                <li><a href="/admin/dashboard.html">Dashboard</a></li>
                <li><a href="/admin/books.html">Qu·∫£n L√Ω S√°ch</a></li>
                <li><a href="/admin/orders.html" class="active">Qu·∫£n L√Ω ƒê∆°n H√†ng</a></li>
                <li><a href="/admin/gift-orders.html">Qu·∫£n L√Ω ƒê∆°n Qu√† T·∫∑ng</a></li>
                <li><a href="/admin/gift-packages.html">Qu·∫£n L√Ω G√≥i Qu√†</a></li>
                <li><a href="/admin/users.html">Qu·∫£n L√Ω Ng∆∞·ªùi D√πng</a></li>
                <li><a href="/admin/memberships.html">Qu·∫£n L√Ω Th·∫ª Th√†nh Vi√™n</a></li>
                <li><a href="/index.html">V·ªÅ Trang Ch·ªß</a></li>
            </ul>
        </aside>
        <main class="admin-content">
            <h1 style="color:#2d6a4f;margin-bottom:1.5rem">Qu·∫£n L√Ω ƒê∆°n H√†ng</h1>
            <div style="margin-bottom:1rem">
                <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm theo m√£ ƒë∆°n, kh√°ch h√†ng, tr·∫°ng th√°i..."
                    style="width:100%;max-width:500px;padding:0.75rem;border:1px solid #ddd;border-radius:4px;font-size:14px"
                    oninput="filterOrders()">
            </div>
            <div class="admin-section">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>M√£ ƒêH</th>
                            <th>Kh√°ch H√†ng</th>
                            <th>Ng√†y ƒê·∫∑t</th>
                            <th>T·ªïng Ti·ªÅn</th>
                            <th>Tr·∫°ng Th√°i</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTable">
                        <tr>
                            <td colspan="6" style="text-align:center">ƒêang t·∫£i...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
    <script src="/js/notification.js"></script>
    <script>
        let allOrders = [];
        fetch('/admin/api/orders', { credentials: 'include' })
            .then(r => r.json())
            .then(orders => { allOrders = orders; displayOrders(orders); })
            .catch(() => document.getElementById('ordersTable').innerHTML = '<tr><td colspan="6" style="text-align:center">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</td></tr>');
        function displayOrders(orders) {
            document.getElementById('ordersTable').innerHTML = orders.length ? orders.map(o => `
                <tr>
                    <td>#${o.orderId}</td>
                    <td>${o.user ? o.user.fullName || o.user.userName : 'N/A'}</td>
                    <td>${new Date(o.orderDate).toLocaleDateString('vi-VN')}</td>
                    <td>${o.totalAmount.toLocaleString('vi-VN')} ‚Ç´</td>
                    <td><span class="badge badge-${o.status.toLowerCase()}">${o.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="location.href='/order-detail.html?id=${o.orderId}'">Xem</button>
                        ${o.status !== 'CANCELLED' && o.status !== 'DELIVERED' ? `<button class="btn btn-sm btn-danger" onclick="cancelOrder(${o.orderId})">H·ªßy</button>` : ''}
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="6" style="text-align:center">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng</td></tr>';
        }
        function filterOrders() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allOrders.filter(o =>
                (o.orderId + '').includes(q) ||
                (o.user && (o.user.fullName || o.user.userName || '').toLowerCase().includes(q)) ||
                (o.status || '').toLowerCase().includes(q)
            );
            displayOrders(filtered);
        }
        function cancelOrder(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n h√†ng #' + id + '?')) return;
            fetch(`/admin/api/orders/${id}/cancel`, { method: 'POST', credentials: 'include' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        showSuccess('Th√†nh C√¥ng', 'ƒê√£ h·ªßy ƒë∆°n h√†ng');
                        fetch('/admin/api/orders', { credentials: 'include' })
                            .then(r => r.json())
                            .then(orders => { allOrders = orders; displayOrders(orders); });
                    } else {
                        showError('L·ªói', data.error || 'Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng');
                    }
                })
                .catch(() => showError('L·ªói', 'Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng'));
        }
    </script>
</body>

</html>