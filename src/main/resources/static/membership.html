<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng K√Ω Th·∫ª Th√†nh Vi√™n - Bookshop</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <a href="/index.html" class="navbar-brand">Bookshop</a>

            <ul class="nav-menu">
                <li><a href="/index.html" class="nav-link">Trang Ch·ªß</a></li>
                <li class="dropdown">
                    <a href="/books.html" class="nav-link dropdown-toggle">S√°ch</a>
                    <div class="dropdown-menu" id="categoryMenu">
                        <a href="/books.html" class="dropdown-item">T·∫•t C·∫£ S√°ch</a>
                    </div>
                </li>
                <li><a href="/cart.html" class="nav-link">Gi·ªè H√†ng</a></li>
            </ul>

            <form id="searchForm" class="header-search">
                <input type="text" id="searchQuery" placeholder="T√¨m ki·∫øm s√°ch..." />
                <button type="submit">T√¨m ki·∫øm</button>
            </form>

            <div id="authSection" class="auth-section"></div>
        </div>
    </nav>

    <main class="content">
        <div class="container">
            <h1 class="section-title">ƒêƒÉng K√Ω Th·∫ª Th√†nh Vi√™n</h1>

            <!-- Current Membership Status -->
            <div id="currentMembershipSection" style="display: none; margin-bottom: 2rem;">
                <div
                    style="background: linear-gradient(135deg, #2d6a4f 0%, #1b4332 100%); color: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                    <h2 style="margin: 0 0 1rem 0; font-size: 1.5rem;">‚ú® Th·∫ª Th√†nh Vi√™n Hi·ªán T·∫°i</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Lo·∫°i th·∫ª</p>
                            <p style="margin: 0.25rem 0 0 0; font-size: 1.3rem; font-weight: bold;" id="currentType">
                            </p>
                        </div>
                        <div>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Gi·∫£m gi√°</p>
                            <p style="margin: 0.25rem 0 0 0; font-size: 1.3rem; font-weight: bold;"
                                id="currentDiscount"></p>
                        </div>
                        <div>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Ng√†y h·∫øt h·∫°n</p>
                            <p style="margin: 0.25rem 0 0 0; font-size: 1.3rem; font-weight: bold;" id="currentExpiry">
                            </p>
                        </div>
                        <div>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Tr·∫°ng th√°i</p>
                            <p style="margin: 0.25rem 0 0 0; font-size: 1.3rem; font-weight: bold;" id="currentStatus">
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Membership Plans -->
            <div style="margin-bottom: 2rem;">
                <h2 style="color: #2d6a4f; margin-bottom: 1.5rem; text-align: center;">Ch·ªçn G√≥i Th√†nh Vi√™n</h2>
                <div class="membership-plans-grid">

                    <!-- Silver Plan -->
                    <div class="membership-card" data-type="SILVER" data-discount="5">
                        <div class="membership-card-header">
                            <h3 style="margin: 0; font-size: 1.8rem;">ü•à SILVER</h3>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.9;">Th·∫ª B·∫°c</p>
                        </div>
                        <div class="membership-card-body">
                            <div class="membership-price">
                                <p class="membership-price-value">5%</p>
                                <p class="membership-price-label">Gi·∫£m gi√°</p>
                            </div>
                            <ul class="membership-features">
                                <li>Gi·∫£m 5% m·ªçi ƒë∆°n h√†ng</li>
                                <li>∆Øu ti√™n h·ªó tr·ª£</li>
                                <li>T√≠ch ƒëi·ªÉm th∆∞·ªüng</li>
                                <li>Th√¥ng b√°o s√°ch m·ªõi</li>
                            </ul>
                            <button onclick="selectPlan('SILVER', 5)" class="btn btn-primary membership-card-button"
                                style="width: 100%;">Ch·ªçn G√≥i N√†y</button>
                        </div>
                    </div>

                    <!-- Gold Plan -->
                    <div class="membership-card" data-type="GOLD" data-discount="10" style="position: relative;">
                        <span class="popular-badge">PH·ªî BI·∫æN</span>
                        <div class="membership-card-header">
                            <h3 style="margin: 0; font-size: 1.8rem;">ü•á GOLD</h3>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.9;">Th·∫ª V√†ng</p>
                        </div>
                        <div class="membership-card-body" style="border: 2px solid #FFD700;">
                            <div class="membership-price">
                                <p class="membership-price-value">10%</p>
                                <p class="membership-price-label">Gi·∫£m gi√°</p>
                            </div>
                            <ul class="membership-features">
                                <li>Gi·∫£m 10% m·ªçi ƒë∆°n h√†ng</li>
                                <li>∆Øu ti√™n h·ªó tr·ª£ VIP</li>
                                <li>T√≠ch ƒëi·ªÉm x2</li>
                                <li>Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn</li>
                                <li>Qu√† t·∫∑ng sinh nh·∫≠t</li>
                            </ul>
                            <button onclick="selectPlan('GOLD', 10)" class="btn btn-primary membership-card-button"
                                style="width: 100%; background: #FFD700; border-color: #FFD700; color: #333;">Ch·ªçn G√≥i
                                N√†y</button>
                        </div>
                    </div>

                    <!-- Platinum Plan -->
                    <div class="membership-card" data-type="PLATINUM" data-discount="15">
                        <div class="membership-card-header" style="color: #333;">
                            <h3 style="margin: 0; font-size: 1.8rem;">üíé PLATINUM</h3>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">Th·∫ª B·∫°ch Kim</p>
                        </div>
                        <div class="membership-card-body">
                            <div class="membership-price">
                                <p class="membership-price-value">15%</p>
                                <p class="membership-price-label">Gi·∫£m gi√°</p>
                            </div>
                            <ul class="membership-features">
                                <li>Gi·∫£m 15% m·ªçi ƒë∆°n h√†ng</li>
                                <li>H·ªó tr·ª£ 24/7</li>
                                <li>T√≠ch ƒëi·ªÉm x3</li>
                                <li>Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn</li>
                                <li>∆Øu ti√™n s√°ch m·ªõi</li>
                                <li>S·ª± ki·ªán ƒë·ªôc quy·ªÅn</li>
                            </ul>
                            <button onclick="selectPlan('PLATINUM', 15)" class="btn btn-primary membership-card-button"
                                style="width: 100%;">Ch·ªçn G√≥i N√†y</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registration Form -->
            <div id="registrationForm"
                style="display: none; max-width: 600px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h2 style="color: #2d6a4f; margin-bottom: 1.5rem; text-align: center;">Th√¥ng Tin ƒêƒÉng K√Ω</h2>

                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <p style="margin: 0; font-weight: bold; color: #2d6a4f;">G√≥i ƒë√£ ch·ªçn: <span
                            id="selectedPlanName"></span></p>
                    <p style="margin: 0.5rem 0 0 0; color: #6c757d;">Gi·∫£m gi√°: <span id="selectedDiscount"></span>%</p>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2d6a4f;">
                        Th·ªùi h·∫°n <span style="color: red;">*</span>
                    </label>
                    <select id="months" onchange="updatePrice()"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                        <option value="3">3 th√°ng</option>
                        <option value="6">6 th√°ng (Ti·∫øt ki·ªám 10%)</option>
                        <option value="12" selected>12 th√°ng (Ti·∫øt ki·ªám 20%)</option>
                    </select>
                    <p id="priceDisplay"
                        style="margin-top: 0.5rem; font-weight: bold; color: #2d6a4f; font-size: 1.1rem;"></p>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2d6a4f;">
                        Ph∆∞∆°ng th·ª©c thanh to√°n <span style="color: red;">*</span>
                    </label>
                    <select id="bankType"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                        <option value="">-- Ch·ªçn ph∆∞∆°ng th·ª©c --</option>
                        <option value="VNPAY">VNPay</option>
                        <option value="MOMO">MoMo</option>
                        <option value="BANK_TRANSFER">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
                    </select>
                </div>

                <div
                    style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #ffc107;">
                    <p style="margin: 0; font-size: 0.9rem; color: #856404;">
                        <strong>L∆∞u √Ω:</strong> Th·∫ª th√†nh vi√™n s·∫Ω ƒë∆∞·ª£c k√≠ch ho·∫°t ngay sau khi thanh to√°n th√†nh c√¥ng.
                    </p>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button onclick="submitMembership()" class="btn btn-primary" style="flex: 1;">
                        ƒêƒÉng K√Ω Ngay
                    </button>
                    <button onclick="cancelRegistration()" class="btn btn-outline" style="flex: 1;">
                        H·ªßy
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- VNPay QR Code Modal -->
    <div id="vnpayQRModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1002; overflow-y: auto;">
        <div
            style="max-width: 500px; margin: 2rem auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <!-- VNPay Header -->
            <div
                style="background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%); padding: 1.5rem; border-radius: 12px 12px 0 0; text-align: center;">
                <h2 style="color: white; margin: 0; font-size: 1.8rem; font-weight: bold;">VNPAY</h2>
                <p style="color: white; margin: 0.5rem 0 0 0; font-size: 1rem;">C·ªïng thanh to√°n ƒëi·ªán t·ª≠</p>
            </div>

            <!-- VNPay Content -->
            <div style="padding: 2rem;">
                <h3 style="color: #0066cc; margin-bottom: 1rem; text-align: center;">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</h3>

                <!-- Order Info -->
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: #6c757d;">G√≥i th√†nh vi√™n:</span>
                        <strong id="vnpayQRMembershipType"></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: #6c757d;">Gi√° tr·ªã thanh to√°n:</span>
                        <strong style="color: #0066cc; font-size: 1.2rem;" id="vnpayQRAmount"></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: #6c757d;">Ph√≠ giao d·ªãch:</span>
                        <strong>0 ‚Ç´</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #6c757d;">M√£ giao d·ªãch:</span>
                        <strong id="vnpayQRRefCode"></strong>
                    </div>
                </div>

                <!-- QR Code -->
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div
                        style="background: white; padding: 1.5rem; border-radius: 8px; border: 2px solid #0066cc; display: inline-block;">
                        <div id="vnpayQRCode" style="width: 200px; height: 200px; background: white;"></div>
                    </div>
                    <p style="margin-top: 1rem; color: #6c757d; font-size: 0.9rem;">
                        S·ª≠ d·ª•ng ·ª©ng d·ª•ng ng√¢n h√†ng ƒë·ªÉ qu√©t m√£ QR
                    </p>
                </div>

                <!-- Warning -->
                <div
                    style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #ffc107;">
                    <p style="margin: 0; font-size: 0.9rem; color: #856404;">
                        <strong>M√¥i tr∆∞·ªùng Test:</strong> ƒê√¢y l√† QR code gi·∫£ l·∫≠p. Trong th·ª±c t·∫ø, ƒë√¢y s·∫Ω l√† QR code
                        th·∫≠t
                        t·ª´ VNPay.
                    </p>
                </div>

                <!-- Buttons -->
                <div style="display: flex; gap: 1rem; flex-direction: column;">
                    <button onclick="confirmVNPayQRPaymentMembership()"
                        style="width: 100%; padding: 1rem; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer;">
                        T√¥i ƒê√£ Thanh To√°n
                    </button>
                    <button onclick="closeVNPayQRModalMembership()"
                        style="width: 100%; padding: 1rem; background: #6c757d; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer;">
                        H·ªßy Thanh To√°n
                    </button>
                </div>

                <div style="text-align: center; margin-top: 1rem;">
                    <p style="font-size: 0.85rem; color: #6c757d;">
                        1900.5555.77 | hotro@vnpay.vn
                    </p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container text-center">
            <p>&copy; 2025 Bookshop. All rights reserved.</p>
        </div>
    </footer>

    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/auth.js?v=2"></script>
    <script src="/js/notification.js"></script>
    <script src="/js/search.js"></script>
    <script>
        let selectedMembershipType = null;
        let selectedDiscount = 0;

        // Check current membership on page load
        function checkCurrentMembership() {
            fetch('/membership/api/current', {
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    return null;
                })
                .then(membership => {
                    if (membership && membership.status === 'ACTIVE') {
                        displayCurrentMembership(membership);
                    }
                })
                .catch(error => {
                    console.error('Error checking membership:', error);
                });
        }

        function displayCurrentMembership(membership) {
            document.getElementById('currentMembershipSection').style.display = 'block';
            document.getElementById('currentType').textContent = membership.membershipType;
            document.getElementById('currentDiscount').textContent = membership.discountPercent + '%';

            const expiryDate = new Date(membership.expiresAt);
            document.getElementById('currentExpiry').textContent = expiryDate.toLocaleDateString('vi-VN');
            document.getElementById('currentStatus').textContent = membership.status === 'ACTIVE' ? 'ƒêang ho·∫°t ƒë·ªông' : 'H·∫øt h·∫°n';
        }

        function selectPlan(type, discount) {
            selectedMembershipType = type;
            selectedDiscount = discount;

            document.getElementById('selectedPlanName').textContent = type;
            document.getElementById('selectedDiscount').textContent = discount;
            document.getElementById('registrationForm').style.display = 'block';
            document.getElementById('registrationForm').scrollIntoView({ behavior: 'smooth' });

            // Update price display
            updatePrice();
        }

        function updatePrice() {
            if (!selectedMembershipType) return;

            const months = parseInt(document.getElementById('months').value);

            // Base prices for each membership type
            const basePrices = {
                'SILVER': 200000,
                'GOLD': 400000,
                'PLATINUM': 600000
            };

            let price = basePrices[selectedMembershipType];

            // Apply discount for longer periods
            if (months === 6) {
                price = price * 0.9; // 10% discount
            } else if (months === 12) {
                price = price * 0.8; // 20% discount
            }

            document.getElementById('priceDisplay').textContent = 'Gi√°: ' + price.toLocaleString('vi-VN') + ' ‚Ç´';
        }

        function cancelRegistration() {
            document.getElementById('registrationForm').style.display = 'none';
            selectedMembershipType = null;
            selectedDiscount = 0;
        }

        function submitMembership() {
            if (!selectedMembershipType) {
                showError('L·ªói', 'Vui l√≤ng ch·ªçn g√≥i th√†nh vi√™n');
                return;
            }

            const months = parseInt(document.getElementById('months').value);
            const bankType = document.getElementById('bankType').value;

            if (!bankType) {
                showError('L·ªói', 'Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n');
                return;
            }

            // Calculate total amount
            const monthlyFee = 50000;
            let totalAmount = monthlyFee * months;

            // Apply discount
            if (months === 6) {
                totalAmount = totalAmount * 0.9; // 10% discount
            } else if (months === 12) {
                totalAmount = totalAmount * 0.8; // 20% discount
            }

            // If VNPay, show QR code
            if (bankType === 'VNPAY') {
                showVNPayQRModalMembership(selectedMembershipType, totalAmount, months);
                return;
            }

            // For other payment methods, proceed with registration
            const membershipData = {
                membershipType: selectedMembershipType,
                months: months,
                bankType: bankType
            };

            fetch('/membership/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(membershipData),
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccess('ƒêƒÉng K√Ω Th√†nh C√¥ng!', 'Th·∫ª th√†nh vi√™n c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t.');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showError('L·ªói', data.message || 'Kh√¥ng th·ªÉ ƒëƒÉng k√Ω th·∫ª th√†nh vi√™n.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('L·ªói', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi server. Vui l√≤ng th·ª≠ l·∫°i.');
                });
        }

        // VNPay QR Code Functions for Membership
        let vnpayQRCodeMembership = null;
        let currentMembershipData = null;

        function showVNPayQRModalMembership(membershipType, amount, months) {
            // Generate fake QR data for demo
            const qrData = `VNPAY|MEMBERSHIP|${membershipType}|${amount}|${months}|Bookshop Green|${Date.now()}`;
            const transactionId = 'VNP' + Date.now();

            // Store membership data for later
            currentMembershipData = {
                membershipType: membershipType,
                months: months,
                bankType: 'VNPAY',
                amount: amount,
                transactionId: transactionId
            };

            // Update modal info
            document.getElementById('vnpayQRMembershipType').textContent = membershipType;
            document.getElementById('vnpayQRAmount').textContent = amount.toLocaleString('vi-VN') + ' ‚Ç´';
            document.getElementById('vnpayQRRefCode').textContent = transactionId;

            // Clear previous QR code
            const qrContainer = document.getElementById('vnpayQRCode');
            qrContainer.innerHTML = '';

            // Check if QRCode library is loaded
            if (typeof QRCode !== 'undefined') {
                // Generate QR Code
                vnpayQRCodeMembership = new QRCode(qrContainer, {
                    text: qrData,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            } else {
                // Fallback if QRCode library not loaded
                qrContainer.innerHTML = '<div style="width: 200px; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 2px dashed #ccc;"><p style="text-align: center; color: #666;">QR Code<br/>Demo</p></div>';
            }

            // Show modal
            document.getElementById('vnpayQRModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeVNPayQRModalMembership() {
            document.getElementById('vnpayQRModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentMembershipData = null;
        }

        function confirmVNPayQRPaymentMembership() {
            if (!currentMembershipData) {
                showError('L·ªói', 'Th√¥ng tin thanh to√°n kh√¥ng h·ª£p l·ªá');
                return;
            }

            // Show processing
            showSuccess('ƒêang x·ª≠ l√Ω...', 'ƒêang x√°c nh·∫≠n thanh to√°n...');

            // Simulate VNPay API call
            setTimeout(() => {
                const membershipData = {
                    membershipType: currentMembershipData.membershipType,
                    months: currentMembershipData.months,
                    bankType: currentMembershipData.bankType
                };

                fetch('/membership/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(membershipData),
                    credentials: 'include'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            closeVNPayQRModalMembership();
                            showSuccess('Thanh To√°n Th√†nh C√¥ng!', 'Th·∫ª th√†nh vi√™n c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t.');
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        } else {
                            showError('L·ªói', data.message || 'X√°c nh·∫≠n thanh to√°n th·∫•t b·∫°i');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showError('L·ªói', 'Kh√¥ng th·ªÉ x√°c nh·∫≠n thanh to√°n');
                    });
            }, 1500); // Simulate network delay
        }

        // Close modal when clicking outside
        document.addEventListener('click', function (e) {
            const vnpayQRModal = document.getElementById('vnpayQRModal');
            if (e.target === vnpayQRModal) {
                closeVNPayQRModalMembership();
            }
        });

        // Load current membership on page load
        checkCurrentMembership();
    </script>
</body>

</html>